YUI.add("moodle-atto_teamsmeeting-button",function(e,t){var n="atto_teamsmeeting",r={NEWWINDOW:"atto_teamsmeeting_openinnewwindow",URLINPUT:"atto_teamsmeeting_urlentry"},i={URLINPUT:".atto_teamsmeeting_urlentry"},s='<form class="atto_form"><div class="meeting-app"><label class="meeting-app-label" for="meetingapp">{{get_string "createteamsmeeting" component}}</label><iframe id="meetingapp" src="{{appurl}}?url={{clientdomain}}&locale={{locale}}"></iframe></div><div class="mb-1"><label for="{{elementid}}_atto_teamsmeeting_urlentry">{{get_string "meetingurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_teamsmeeting_urlentry" size="32" disabled="disabled"/></div><div class="form-check"><input type="checkbox" class="form-check-input newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><div class="mdl-align"><br/><button type="submit" class="btn btn-secondary submit">{{get_string "addlink" component}}</button></div></form>';e.namespace("M.atto_teamsmeeting").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_clientdomain:null,_appurl:null,_locale:null,initializer:function(){this._clientdomain=this.get("clientdomain"),this._appurl=this.get("appurl"),this._locale=this.get("locale"),this.addButton({icon:"icon",iconComponent:"atto_teamsmeeting",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var e=this.getDialogue({headerContent:M.util.get_string("createteamsmeeting",n),width:"auto",focusAfterHide:!0,focusOnShowSelector:i.URLINPUT});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),e.show()},_resolveAnchors:function(){var t=this.get("host").getSelectionParentNode(),n,r,i,s;if(!t)return;n=this._findSelectedAnchors(e.one(t));if(n.length>0){r=n[0],this._currentSelection=this.get("host").getSelectionFromNode(r),i=r.getAttribute("href"),s=r.getAttribute("target");if(i!==""){this._content.one(".url").setAttribute("value",i);var o=M.cfg.wwwroot+"/lib/editor/atto/plugins/teamsmeeting/ajax.php",u={url:i};e.io(o,{context:this,data:u,timeout:500,on:{complete:this._updateIframe}})}s==="_blank"?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked")}},_meetingcheck:function(){if(document.getElementById("meetingapp").contentDocument){var e=document.getElementById("meetingapp").contentDocument.location;if(e!==""&&e.pathname.indexOf("teamsmeeting")>-1){var t=this._getqueryvariable("link",e),n=this._content.one(".url");n.set("value",t)}}},_updateIframe:function(e,t){if(t.status===200){var n=JSON.parse(t.responseText);if(n[2]!==null){var r=n[0]+"?title="+n[1]+"&link="+encodeURIComponent(n[2])+"&options="+encodeURIComponent(n[3]);this._content.one("#meetingapp").set("src",r)}}},_getqueryvariable:function(e,t){var n=t.search.substring(1),r=n.split("&");for(var i=0;i<r.length;i++){var s=r[i].split("=");if(decodeURIComponent(s[0])==e)return decodeURIComponent(s[1])}},_setteamsmeeting:function(e){var t,n;e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),t=this._content.one(".url"),n=t.get("value");if(n!==""){n=n.trim();var r=new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/);r.test(n)||(n="http://"+n),this._setteamsmeetingOnSelection(n),this.markUpdated()}},_setteamsmeetingOnSelection:function(t){var r=this.get("host"),i,s,o,u;this.editor.focus(),r.setSelection(this._currentSelection),this._currentSelection[0].collapsed?(i=e.Node.create("<a>"+M.util.get_string("linktext",n)+"</a>"),i.setAttribute("href",t),s=r.insertContentAtFocusPoint(i.get("outerHTML")),r.setSelection(r.getSelectionFromNode(s))):(document.execCommand("unlink",!1,null),document.execCommand("createlink",!1,t),s=r.getSelectionParentNode());if(!s)return;return u=this._findSelectedAnchors(e.one(s)),e.Array.each(u,function(e){o=this._content.one(".newwindow"),o.get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target")},this),s},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(){var t=e.Handlebars.compile(s);return this._content=e.Node.create(t({clientdomain:this._clientdomain,appurl:this._appurl,locale:this._locale,component:n,CSS:r})),this._content.one(".submit").on("click",this._setteamsmeeting,this),this._content.one("iframe").on("load",this._meetingcheck,this),this._content}},{ATTRS:{clientdomain:{value:null},appurl:{value:null},locale:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
