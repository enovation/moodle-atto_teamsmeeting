YUI.add("moodle-atto_teamsmeeting-button",function(i,e){var t="atto_teamsmeeting",n={NEWWINDOW:"atto_teamsmeeting_openinnewwindow",URLINPUT:"atto_teamsmeeting_urlentry"},o=".atto_teamsmeeting_urlentry";i.namespace("M.atto_teamsmeeting").Button=i.Base.create("button",i.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_clientdomain:null,_appurl:null,_locale:null,_msession:null,initializer:function(){this._clientdomain=this.get("clientdomain"),this._appurl=this.get("appurl"),this._locale=this.get("locale"),this._msession=this.get("msession"),this._disabled=this.get("disabled"),this._disabled||this.addButton({icon:"icon",iconComponent:"atto_teamsmeeting",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){var e;this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&((e=this.getDialogue({headerContent:M.util.get_string("createteamsmeeting",t),width:"auto",focusAfterHide:!0,focusOnShowSelector:o})).set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),e.show())},_resolveAnchors:function(){var e,t,n=this.get("host").getSelectionParentNode();n&&0<(n=this._findSelectedAnchors(i.one(n))).length&&(n=n[0],this._currentSelection=this.get("host").getSelectionFromNode(n),e=n.getAttribute("href"),n=n.getAttribute("target"),""!==e&&(this._content.one(".url").setAttribute("value",e),t=M.cfg.wwwroot+"/lib/editor/atto/plugins/teamsmeeting/ajax.php",i.io(t,{context:this,data:{url:e},timeout:500,on:{complete:this._updateIframe}})),"_blank"===n?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked"))},_meetingcheck:function(){var e;document.getElementById("meetingapp").contentDocument&&""!==(e=document.getElementById("meetingapp").contentDocument.location)&&-1<e.pathname.indexOf("teamsmeeting")&&(e=this._getqueryvariable("link",e),this._content.one(".url").set("value",e))},_updateIframe:function(e,t){200===t.status&&null!==(t=JSON.parse(t.responseText))[2]&&(t=t[0]+"?title="+t[1]+"&link="+encodeURIComponent(t[2])+"&options="+encodeURIComponent(t[3]),this._content.one("#meetingapp").set("src",t))},_getqueryvariable:function(e,t){for(var n,t=t.search.substring(1),i=t.split("&"),o=0;o<i.length;o++)if(n=i[o].split("="),decodeURIComponent(n[0])==e)return decodeURIComponent(n[1])},_setteamsmeeting:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),""!==(e=this._content.one(".url").get("value"))&&(e=e.trim(),new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/).test(e)||(e="http://"+e),this._setteamsmeetingOnSelection(e),this.markUpdated())},_setteamsmeetingOnSelection:function(e){var t,n=this.get("host");if(this.editor.focus(),n.setSelection(this._currentSelection),this._currentSelection[0].collapsed?((t=i.Node.create("<a>"+e+"</a>")).setAttribute("href",e),t=n.insertContentAtFocusPoint(t.get("outerHTML")),n.setSelection(n.getSelectionFromNode(t))):(document.execCommand("unlink",!1,null),document.execCommand("createlink",!1,e),t=n.getSelectionParentNode()),t)return e=this._findSelectedAnchors(i.one(t)),i.Array.each(e,function(e){this._content.one(".newwindow").get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target")},this),t},_findSelectedAnchors:function(e){var t,n,i=e.get("tagName");return i&&"a"===i.toLowerCase()?[e]:(n=[],e.all("a").each(function(e){!t&&this.get("host").selectionContainsNode(e)&&n.push(e)},this),0<n.length?n:(t=e.ancestor("a"))?[t]:[])},_getDialogueContent:function(){var e=i.Handlebars.compile('<form class="atto_form"><div class="meeting-app"><label class="meeting-app-label" for="meetingapp">{{get_string "createteamsmeeting" component}}</label><iframe id="meetingapp" src="{{appurl}}?url={{clientdomain}}&locale={{locale}}&msession={{msession}}"></iframe></div><div class="mb-1"><label for="{{elementid}}_atto_teamsmeeting_urlentry">{{get_string "meetingurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_teamsmeeting_urlentry" size="32" disabled="disabled"/></div><div class="form-check"><input type="checkbox" class="form-check-input newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><div class="mdl-align"><br/><button type="submit" class="btn btn-secondary submit">{{get_string "addlink" component}}</button></div></form>');return this._content=i.Node.create(e({clientdomain:this._clientdomain,appurl:this._appurl,locale:this._locale,msession:this._msession,component:t,CSS:n})),this._content.one(".submit").on("click",this._setteamsmeeting,this),this._content.one("iframe").on("load",this._meetingcheck,this),this._content}},{ATTRS:{clientdomain:{value:null},appurl:{value:null},locale:{value:null},msession:{value:null},disabled:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});